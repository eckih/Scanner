<script>
console.log("üîß Direct ActionCable Test startet...");
console.log("üîß window.ActionCable:", typeof window.ActionCable);

document.addEventListener('DOMContentLoaded', function() {
  console.log("üîß DOM loaded - ActionCable Test");
  console.log("üîß window.ActionCable nach DOM load:", typeof window.ActionCable);
  
  // Funktion zum Warten auf ActionCable
  function waitForActionCable(maxAttempts = 20) {
    return new Promise((resolve, reject) => {
      let attempts = 0;
      
      function check() {
        attempts++;
        console.log(`üîß ActionCable Check Versuch ${attempts}:`, typeof window.ActionCable);
        
        if (typeof window.ActionCable !== 'undefined') {
          console.log("üéâ ActionCable gefunden nach", attempts, "Versuchen!");
          resolve();
        } else if (attempts >= maxAttempts) {
          console.log("‚ùå ActionCable nach", attempts, "Versuchen nicht gefunden");
          reject(new Error("ActionCable nicht verf√ºgbar"));
        } else {
          setTimeout(check, 200); // Alle 200ms pr√ºfen
        }
      }
      
      check();
    });
  }
  
  // Warte auf ActionCable und starte dann die Verbindung
  waitForActionCable().then(() => {
    console.log("üîß ActionCable ist verf√ºgbar, starte Verbindung...");
    
    if (typeof window.ActionCable !== 'undefined') {
      console.log("üéâ ActionCable gefunden! Erstelle Verbindung...");
      
      // WebSocket URL bestimmen
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      const host = window.location.host;
      const wsUrl = `${protocol}//${host}/cable`;
      
      console.log("üîå WebSocket URL:", wsUrl);
      
      // Consumer erstellen
      const consumer = ActionCable.createConsumer(wsUrl);
      console.log("üîå Consumer erstellt:", consumer);
      
      // PricesChannel subscription
      const subscription = consumer.subscriptions.create("PricesChannel", {
        connected() {
          console.log("üéâ ERFOLGREICH mit PricesChannel verbunden!");
        },
        
        disconnected() {
          console.log("‚ùå Von PricesChannel getrennt");
        },
        
        rejected() {
          console.log("üö´ PricesChannel Subscription abgelehnt");
        },
        
                              received(data) {
               // Debug: Zeige die vollst√§ndige Nachrichtenstruktur
               console.log("üì® Rohe ActionCable-Nachricht:", data);
               console.log("üì® Nachrichtentyp:", typeof data);
               console.log("üì® Nachricht hat message:", 'message' in data);
               
               // ActionCable-Nachrichten sind oft in einem 'message'-Objekt verschachtelt
               const messageData = data.message || data; // Nutze data.message, falls vorhanden, sonst direkt data
               console.log("üì® Verarbeitete Nachrichtendaten:", messageData);
               console.log("üîç Update-Type:", messageData.update_type);
               
               // Behandle Z√§hler-Updates zuerst (diese haben keine cryptocurrency_id)
               if (messageData.update_type === 'counters') {
                 console.log("üìä Z√§hler-Update erhalten:", messageData);
                 handleCounterUpdate(messageData);
                 return;
               }
               
               // Ignoriere Nachrichten ohne cryptocurrency_id oder symbol (au√üer Z√§hler-Updates)
               if (!messageData.cryptocurrency_id || !messageData.symbol) {
                 console.log("‚ö†Ô∏è Nachricht ohne cryptocurrency_id oder symbol ignoriert:", messageData);
                 return;
               }

               // Behandle verschiedene Update-Typen
               if (messageData.update_type === 'rsi') {
                 console.log("üìä RSI-Update erhalten:", messageData);
                 handleRsiUpdate(messageData);
                 return;
               }
               
               if (messageData.update_type === 'indicator') {
                 console.log("üìä Indikator-Update erhalten:", messageData);
                 handleIndicatorUpdate(messageData);
                 return;
               }
               
               // Unterscheide zwischen Echtzeit-Updates und abgeschlossenen Kerzen (f√ºr Preis-Updates)
               const updateType = messageData.realtime ? "üöÄ ECHTZEIT" : "üìä KERZE";
               console.log(`üì® ${updateType} Preis-Update erhalten:`, messageData);
               
               // DOM Update
               // DEBUG: Zeige verf√ºgbare data-crypto-id Attribute
               const allRows = document.querySelectorAll('[data-crypto-id]');
               console.log("üîç Verf√ºgbare data-crypto-id:", Array.from(allRows).map(r => r.getAttribute('data-crypto-id')));
               console.log("üéØ Suche nach ID:", messageData.cryptocurrency_id);
               
               const row = document.querySelector(`[data-crypto-id='${messageData.cryptocurrency_id}']`);
               if (row) {
                 console.log(`üéØ Zeile gefunden f√ºr Crypto ID: ${messageData.cryptocurrency_id} (${messageData.symbol})`);
                 
                 // Preis-Update
                 const priceCell = row.querySelector('.price-cell');
                 if (priceCell) {
                   const price = parseFloat(messageData.price);
                   const formattedPrice = price >= 1 ? `$${price.toFixed(2)}` : `$${price.toFixed(6)}`;
                   
                   // Erstelle oder aktualisiere den Link
                   let priceLink = priceCell.querySelector('a');
                   if (priceLink) {
                     // Link existiert bereits, nur Text aktualisieren
                     priceLink.textContent = formattedPrice;
                   } else {
                     // Kein Link vorhanden (war N/A), erstelle neuen Link
                     priceCell.innerHTML = `<a href="/cryptocurrencies/${messageData.cryptocurrency_id}/chart" target="_blank" class="text-decoration-none text-primary chart-link" title="Chart anzeigen">${formattedPrice}</a>`;
                   }
                   console.log(`üí∞ ${updateType} Preis aktualisiert: ${formattedPrice} (${messageData.symbol})`);
                   
                   // Verschiedene Animationen f√ºr verschiedene Update-Typen
                   if (messageData.realtime) {
                     // Subtile Animation f√ºr Echtzeit-Updates (h√§ufig)
                     priceCell.style.transition = 'background-color 0.15s ease';
                     priceCell.style.backgroundColor = '#e3f2fd'; // Hellblau f√ºr Echtzeit
                     setTimeout(() => {
                       priceCell.style.backgroundColor = '';
                     }, 150);
                   } else {
                     // Auff√§lligere Animation f√ºr abgeschlossene Kerzen (seltener)
                     priceCell.style.transition = 'background-color 0.5s ease';
                     priceCell.style.backgroundColor = '#d4edda'; // Gr√ºn f√ºr abgeschlossene Kerzen
                     setTimeout(() => {
                       priceCell.style.backgroundColor = '';
                     }, 500);
                   }
                 } else {
                   console.log(`‚ö†Ô∏è Preis-Zelle nicht gefunden f√ºr ${messageData.symbol}`);
                 }
                 
                 // 24h √Ñnderung Update (nur bei abgeschlossenen Kerzen)
                 if (messageData.candle_closed && messageData.price_change_24h !== undefined) {
                   const change24hCell = row.querySelector('td:nth-child(5)'); // 5. Spalte ist "24h √Ñnderung"
                   if (change24hCell) {
                     const change24h = parseFloat(messageData.price_change_24h);
                     const formattedChange = messageData.price_change_24h_formatted || 
                       (change24h >= 0 ? `+${change24h.toFixed(2)}%` : `${change24h.toFixed(2)}%`);
                     
                     // Bestimme die Farbe basierend auf Wert und Vollst√§ndigkeit
                     let colorClass = 'text-danger'; // Standard: rot f√ºr unvollst√§ndige Daten
                     
                     if (messageData.price_change_24h_complete === true) {
                       // Vollst√§ndige 24h Daten - normale Farben
                       colorClass = change24h >= 0 ? 'text-success' : 'text-danger';
                     } else {
                       // Unvollst√§ndige Daten - immer rot (wie bei 0.00)
                       colorClass = 'text-danger';
                     }
                     
                     // Aktualisiere den Text und die Farbe
                     change24hCell.innerHTML = `
                       <span class="${colorClass}">
                         ${change24h >= 0 ? '<i class="bi bi-arrow-up"></i>' : '<i class="bi bi-arrow-down"></i>'}
                         ${formattedChange}
                       </span>
                     `;
                     
                     const updateType = messageData.price_change_24h_complete ? "üìà 24h √Ñnderung (vollst√§ndig)" : "‚ö†Ô∏è 24h √Ñnderung (unvollst√§ndig)";
                     console.log(`${updateType} aktualisiert: ${formattedChange} (${messageData.symbol})`);
                     
                     // Animation f√ºr 24h √Ñnderung
                     change24hCell.style.transition = 'background-color 0.5s ease';
                     change24hCell.style.backgroundColor = colorClass === 'text-success' ? '#d4edda' : '#f8d7da';
                     setTimeout(() => {
                       change24hCell.style.backgroundColor = '';
                     }, 500);
                   }
                 }
                 
                 // Market Cap Update (nur bei abgeschlossenen Kerzen)
                 if (messageData.candle_closed && messageData.market_cap !== undefined) {
                   const marketCapCell = row.querySelector('td:nth-child(6)'); // 6. Spalte ist "Market Cap"
                   if (marketCapCell) {
                     const marketCap = messageData.market_cap_formatted || 'N/A';
                     marketCapCell.textContent = marketCap;
                     
                     console.log(`üìä Market Cap aktualisiert: ${marketCap} (${messageData.symbol})`);
                     
                     // Animation f√ºr Market Cap
                     marketCapCell.style.transition = 'background-color 0.5s ease';
                     marketCapCell.style.backgroundColor = '#e3f2fd'; // Hellblau f√ºr Market Cap
                     setTimeout(() => {
                       marketCapCell.style.backgroundColor = '';
                     }, 500);
                   }
                 }
                 
                 // Volume 24h Update (nur bei abgeschlossenen Kerzen)
                 if (messageData.candle_closed && messageData.volume_24h !== undefined) {
                   const volumeCell = row.querySelector('td:nth-child(7)'); // 7. Spalte ist "Volumen 24h"
                   if (volumeCell) {
                     const volume = messageData.volume_24h_formatted || 'N/A';
                     volumeCell.textContent = volume;
                     
                     console.log(`üìà Volume 24h aktualisiert: ${volume} (${messageData.symbol})`);
                     
                     // Animation f√ºr Volume
                     volumeCell.style.transition = 'background-color 0.5s ease';
                     volumeCell.style.backgroundColor = '#fff3cd'; // Hellgelb f√ºr Volume
                     setTimeout(() => {
                       volumeCell.style.backgroundColor = '';
                     }, 500);
                   }
                 }
               } else {
                 console.log(`‚ùå Keine Zeile gefunden f√ºr Crypto ID: ${messageData.cryptocurrency_id} (${messageData.symbol})`);
                 console.log("üîç Verf√ºgbare Zeilen:", Array.from(document.querySelectorAll('[data-crypto-id]')).map(r => ({
                   id: r.getAttribute('data-crypto-id'),
                   symbol: r.querySelector('td:first-child')?.textContent?.trim()
                 })));
               }
             }
      });
      
      console.log("üì° Subscription erstellt:", subscription);
      
         } else {
       console.error("‚ùå ActionCable nicht verf√ºgbar!");
     }
   }).catch((error) => {
     console.error("‚ùå Fehler beim Laden von ActionCable:", error);
   });

 // Funktion zum Behandeln von RSI-Updates
 function handleRsiUpdate(data) {
   console.log("üìä Verarbeite RSI-Update f√ºr", data.symbol, ":", data.rsi);
   console.log("üîç Suche nach Crypto ID:", data.cryptocurrency_id);
   
   // Debug: Zeige alle verf√ºgbaren data-crypto-id Attribute
   const allRows = document.querySelectorAll('[data-crypto-id]');
   console.log("üîç Verf√ºgbare data-crypto-id:", Array.from(allRows).map(r => ({
     id: r.getAttribute('data-crypto-id'),
     symbol: r.querySelector('td span.badge')?.textContent?.trim()
   })));
   
   const row = document.querySelector(`[data-crypto-id='${data.cryptocurrency_id}']`);
   if (!row) {
     console.log("‚ö†Ô∏è Zeile nicht gefunden f√ºr Crypto ID:", data.cryptocurrency_id);
     console.log("üîç Versuche Symbol-basierte Suche f√ºr:", data.symbol);
     
     // Fallback: Suche nach Symbol
     const searchSymbol = data.symbol.replace('USDC', '').replace('USDT', '');
     const allTableRows = document.querySelectorAll('tbody tr');
     let foundRow = null;
     
     for (const tableRow of allTableRows) {
       const symbolCell = tableRow.querySelector('td span.badge');
       if (symbolCell && symbolCell.textContent.trim() === searchSymbol) {
         foundRow = tableRow;
         console.log("‚úÖ Zeile gefunden √ºber Symbol-Matching:", data.symbol, "->", searchSymbol);
         break;
       }
     }
     
     if (!foundRow) {
       console.log("‚ùå Keine Zeile gefunden f√ºr Symbol:", data.symbol);
       return;
     }
     
     // Verwende die gefundene Zeile
     const rsiCell = foundRow.querySelector('.rsi-cell');
     if (rsiCell) {
       const rsiValue = parseFloat(data.rsi);
       console.log("üîç RSI-Zelle gefunden, aktualisiere Wert:", rsiValue.toFixed(2));
       rsiCell.textContent = rsiValue.toFixed(2);
       
       // RSI-Farbe basierend auf Wert
       rsiCell.className = 'badge rsi-cell';
       if (rsiValue >= 70) {
         rsiCell.classList.add('rsi-overbought'); // √úberkauft
       } else if (rsiValue <= 30) {
         rsiCell.classList.add('rsi-oversold'); // √úberverkauft  
       } else {
         rsiCell.classList.add('rsi-neutral'); // Neutral
       }
       
       // Animation f√ºr RSI-Update
       rsiCell.style.transition = 'background-color 0.8s ease';
       rsiCell.style.backgroundColor = '#fff3cd'; // Gelber Hintergrund
       setTimeout(() => {
         rsiCell.style.backgroundColor = '';
       }, 800);
       
       console.log("‚úÖ RSI-Update abgeschlossen f√ºr:", data.symbol, "- Wert:", rsiValue.toFixed(2));
     } else {
       console.log("‚ö†Ô∏è RSI-Zelle nicht gefunden in Symbol-basierter Zeile");
       console.log("üîç Zeilen-HTML:", foundRow.innerHTML);
     }
     return;
   }
   
   const rsiCell = row.querySelector('.rsi-cell');
   if (rsiCell) {
     const rsiValue = parseFloat(data.rsi);
     console.log("üîç RSI-Zelle gefunden, aktualisiere Wert:", rsiValue.toFixed(2));
     rsiCell.textContent = rsiValue.toFixed(2);
     
     // RSI-Farbe basierend auf Wert
     rsiCell.className = 'badge rsi-cell';
     if (rsiValue >= 70) {
       rsiCell.classList.add('rsi-overbought'); // √úberkauft
     } else if (rsiValue <= 30) {
       rsiCell.classList.add('rsi-oversold'); // √úberverkauft
     } else {
       rsiCell.classList.add('rsi-neutral'); // Neutral
     }
     
     // Animation f√ºr RSI-Update
     rsiCell.style.transition = 'background-color 0.8s ease';
     rsiCell.style.backgroundColor = '#fff3cd'; // Gelber Hintergrund
     setTimeout(() => {
       rsiCell.style.backgroundColor = '';
     }, 800);
     
     console.log("‚úÖ RSI-Update abgeschlossen f√ºr:", data.symbol, "- Wert:", rsiValue.toFixed(2));
   } else {
     console.log("‚ö†Ô∏è RSI-Zelle nicht gefunden f√ºr Crypto ID:", data.cryptocurrency_id);
     console.log("üîç Zeilen-HTML:", row.innerHTML);
   }
 }
 
 // Funktion zum Behandeln von Indikator-Updates
 function handleIndicatorUpdate(data) {
   console.log("üìä Verarbeite Indikator-Update f√ºr", data.symbol, ":", data.indicator_type, "=", data.value);
   
   const row = document.querySelector(`[data-crypto-id='${data.cryptocurrency_id}']`);
   if (!row) {
     console.log("‚ö†Ô∏è Zeile nicht gefunden f√ºr Crypto ID:", data.cryptocurrency_id);
     return;
   }
   
   // Behandle verschiedene Indikator-Typen
   switch (data.indicator_type) {
     case 'rsi':
       handleRsiUpdate({
         cryptocurrency_id: data.cryptocurrency_id,
         symbol: data.symbol,
         rsi: data.value
       });
       break;
       
     case 'roc':
       handleRocUpdate({
         cryptocurrency_id: data.cryptocurrency_id,
         symbol: data.symbol,
         roc: data.value
       });
       break;
       
     case 'roc_derivative':
       handleRocDerivativeUpdate({
         cryptocurrency_id: data.cryptocurrency_id,
         symbol: data.symbol,
         roc_derivative: data.value
       });
       break;
       
     default:
       console.log(`üìä Unbekannter Indikator-Typ: ${data.indicator_type}`);
   }
 }

 // Funktion zum Behandeln von ROC-Updates
 function handleRocUpdate(data) {
   console.log("üìä Verarbeite ROC-Update f√ºr", data.symbol, ":", data.roc);
   
   const row = document.querySelector(`[data-crypto-id='${data.cryptocurrency_id}']`);
   if (!row) {
     console.log("‚ö†Ô∏è Zeile nicht gefunden f√ºr ROC Update, Crypto ID:", data.cryptocurrency_id);
     return;
   }
   
   const rocCell = row.querySelector('.roc-cell');
   if (rocCell) {
     const rocValue = parseFloat(data.roc);
     rocCell.textContent = `${rocValue.toFixed(2)}%`;
     
     // Aktualisiere CSS-Klassen basierend auf ROC-Wert
     rocCell.className = 'badge roc-cell';
     if (rocValue >= 5) {
       rocCell.classList.add('bg-success');
     } else if (rocValue <= -5) {
       rocCell.classList.add('bg-danger');
     } else {
       rocCell.classList.add('bg-secondary');
     }
     
     console.log(`‚úÖ ROC aktualisiert f√ºr ${data.symbol}: ${rocValue.toFixed(2)}%`);
   } else {
     console.log("‚ö†Ô∏è ROC-Zelle nicht gefunden f√ºr", data.symbol);
   }
 }

 // Funktion zum Behandeln von ROC Derivative Updates
 function handleRocDerivativeUpdate(data) {
   console.log("üìä Verarbeite ROC' Update f√ºr", data.symbol, ":", data.roc_derivative);
   
   const row = document.querySelector(`[data-crypto-id='${data.cryptocurrency_id}']`);
   if (!row) {
     console.log("‚ö†Ô∏è Zeile nicht gefunden f√ºr ROC' Update, Crypto ID:", data.cryptocurrency_id);
     return;
   }
   
   const rocDerivativeCell = row.querySelector('.roc-derivative-cell');
   if (rocDerivativeCell) {
     const rocDerivativeValue = parseFloat(data.roc_derivative);
     rocDerivativeCell.textContent = `${rocDerivativeValue.toFixed(2)}%`;
     
     // Aktualisiere CSS-Klassen basierend auf ROC' Wert
     rocDerivativeCell.className = 'badge roc-derivative-cell';
     if (rocDerivativeValue >= 2) {
       rocDerivativeCell.classList.add('bg-success');
     } else if (rocDerivativeValue <= -2) {
       rocDerivativeCell.classList.add('bg-danger');
     } else {
       rocDerivativeCell.classList.add('bg-secondary');
     }
     
     console.log(`‚úÖ ROC' aktualisiert f√ºr ${data.symbol}: ${rocDerivativeValue.toFixed(2)}%`);
   } else {
     console.log("‚ö†Ô∏è ROC'-Zelle nicht gefunden f√ºr", data.symbol);
   }
 }

  // Funktion zum Behandeln von Z√§hler-Updates
  function handleCounterUpdate(data) {
    console.log("üìä Verarbeite Z√§hler-Update:", data);
    
    const messageCounter = document.getElementById('message-counter');
    const klineCounter = document.getElementById('kline-counter');
    const priceUpdateCounter = document.getElementById('price-update-counter');
    const dataRateCounter = document.getElementById('data-rate-counter');

    if (messageCounter) {
      messageCounter.textContent = data.message_counter || 0;
      console.log("üí¨ Nachrichten-Z√§hler aktualisiert:", data.message_counter);
    }
    if (klineCounter) {
      klineCounter.textContent = data.kline_counter || 0;
      console.log("üìà Klines-Z√§hler aktualisiert:", data.kline_counter);
    }
    if (priceUpdateCounter) {
      priceUpdateCounter.textContent = data.price_update_counter || 0;
      console.log("üí∞ Preis-Updates-Z√§hler aktualisiert:", data.price_update_counter);
    }
    if (rsiCalculationCounter) {
      rsiCalculationCounter.textContent = data.rsi_calculation_counter || 0;
      console.log("üìä RSI-Berechnungen-Z√§hler aktualisiert:", data.rsi_calculation_counter);
    }
    if (dataRateCounter) {
      dataRateCounter.textContent = data.data_rate || 0;
      console.log("üíæ Datenrate aktualisiert:", data.data_rate);
    }
  }

  // Timeframe und RSI-Konfiguration Funktionalit√§t (nur Frontend)
  const timeframeSelector = document.getElementById('timeframe-selector');
  const rsiPeriodInput = document.getElementById('rsi-period-input');
  
  if (timeframeSelector && rsiPeriodInput) {
    // Lade gespeicherte Werte aus localStorage
    const savedTimeframe = localStorage.getItem('selected-timeframe');
    const savedRsiPeriod = localStorage.getItem('selected-rsi-period');
    
                    if (savedTimeframe) {
                  timeframeSelector.value = savedTimeframe;
                  console.log('üïê Gespeicherter Timeframe geladen:', savedTimeframe);
                } else {
                  // Standard: 1 Minute
                  timeframeSelector.value = '1m';
                  localStorage.setItem('selected-timeframe', '1m');
                  console.log('üïê Standard-Timeframe gesetzt: 1m');
                }
                
                if (savedRsiPeriod) {
                  rsiPeriodInput.value = savedRsiPeriod;
                  console.log('üìä Gespeicherte RSI-Periode geladen:', savedRsiPeriod);
                } else {
                  // Standard: 14
                  rsiPeriodInput.value = '14';
                  localStorage.setItem('selected-rsi-period', '14');
                  console.log('üìä Standard-RSI-Periode gesetzt: 14');
                }
                
                // Aktualisiere Backend mit aktuellen Einstellungen beim Laden der Seite
                updateBackendSettings(timeframeSelector.value, rsiPeriodInput.value);
    
                    // Event Listener f√ºr Timeframe-√Ñnderungen
                timeframeSelector.addEventListener('change', function() {
                  const selectedTimeframe = this.value;
                  localStorage.setItem('selected-timeframe', selectedTimeframe);
                  
                  console.log('üïê Timeframe ge√§ndert zu:', selectedTimeframe);
                  
                  // Speichere Timeframe im Rails-Cache f√ºr WebSocket-Service
                  updateBackendSettings(selectedTimeframe, rsiPeriodInput.value);
                  
                  // Zeige Benachrichtigung
                  showTimeframeNotification(selectedTimeframe, 'info');
                  
                  // Starte RSI-Berechnung mit neuem Timeframe
                  startRsiCalculation(selectedTimeframe, rsiPeriodInput.value);
                });
    
                    // Event Listener f√ºr RSI-Perioden-√Ñnderungen
                rsiPeriodInput.addEventListener('change', function() {
                  const selectedRsiPeriod = this.value;
                  localStorage.setItem('selected-rsi-period', selectedRsiPeriod);
                  
                  console.log('üìä RSI-Periode ge√§ndert zu:', selectedRsiPeriod);
                  
                  // Speichere RSI-Periode im Rails-Cache f√ºr WebSocket-Service
                  updateBackendSettings(timeframeSelector.value, selectedRsiPeriod);
                  
                  // Zeige Benachrichtigung
                  showRsiPeriodNotification(selectedRsiPeriod, 'info');
                  
                  // Starte RSI-Berechnung mit neuer Periode
                  startRsiCalculation(timeframeSelector.value, selectedRsiPeriod);
                });
    
                    // Funktion zum Aktualisieren der Backend-Einstellungen
                function updateBackendSettings(timeframe, period) {
                  fetch('/cryptocurrencies/update_rsi_settings', {
                    method: 'POST',
                    headers: {
                      'Content-Type': 'application/json',
                      'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
                    },
                    body: JSON.stringify({ 
                      timeframe: timeframe, 
                      period: parseInt(period) 
                    })
                  })
                  .then(response => response.json())
                  .then(data => {
                    if (data.success) {
                      console.log('‚úÖ Backend-Einstellungen aktualisiert:', data.message);
                    } else {
                      console.error('‚ùå Fehler beim Aktualisieren der Backend-Einstellungen:', data.error);
                    }
                  })
                  .catch(error => {
                    console.error('‚ùå Netzwerkfehler beim Aktualisieren der Backend-Einstellungen:', error);
                  });
                }
                
                // Funktion zum Starten der RSI-Berechnung
                function startRsiCalculation(timeframe, period) {
      console.log('üöÄ Starte RSI-Berechnung:', { timeframe, period });
      
      fetch('/cryptocurrencies/calculate_rsi', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
        },
        body: JSON.stringify({ 
          timeframe: timeframe, 
          period: parseInt(period) 
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          console.log('‚úÖ RSI-Berechnung gestartet:', data.message);
          showCalculationNotification('RSI-Berechnung gestartet', 'success');
        } else {
          console.error('‚ùå Fehler bei RSI-Berechnung:', data.error);
          showCalculationNotification('Fehler bei RSI-Berechnung', 'error');
        }
      })
      .catch(error => {
        console.error('‚ùå Netzwerkfehler bei RSI-Berechnung:', error);
        showCalculationNotification('Netzwerkfehler bei RSI-Berechnung', 'error');
      });
    }
    
    // Funktion zum Anzeigen einer Berechnungs-Benachrichtigung
    function showCalculationNotification(message, type = 'info') {
      // Entferne bestehende Benachrichtigung
      const existingNotification = document.querySelector('.calculation-notification');
      if (existingNotification) {
        existingNotification.remove();
      }
      
      // Bestimme CSS-Klasse basierend auf Typ
      let alertClass = 'alert-info';
      let icon = 'bi-calculator';
      
      if (type === 'success') {
        alertClass = 'alert-success';
        icon = 'bi-check-circle';
      } else if (type === 'error') {
        alertClass = 'alert-danger';
        icon = 'bi-exclamation-triangle';
      }
      
      // Erstelle neue Benachrichtigung
      const notification = document.createElement('div');
      notification.className = `calculation-notification alert ${alertClass} alert-dismissible fade show position-fixed`;
      notification.style.cssText = 'top: 60px; right: 20px; z-index: 1050; max-width: 300px;';
      
      notification.innerHTML = `
        <i class="bi ${icon}"></i>
        <strong>${message}</strong>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      
      document.body.appendChild(notification);
      
      // Automatisch nach 5 Sekunden ausblenden
      setTimeout(() => {
        if (notification.parentNode) {
          notification.remove();
        }
      }, 5000);
    }
    
    // Funktion zum Anzeigen einer Benachrichtigung
    function showTimeframeNotification(timeframe, type = 'info') {
      // Entferne bestehende Benachrichtigung
      const existingNotification = document.querySelector('.timeframe-notification');
      if (existingNotification) {
        existingNotification.remove();
      }
      
      // Bestimme CSS-Klasse basierend auf Typ
      let alertClass = 'alert-info';
      let icon = 'bi-clock';
      let message = 'Timeframe ge√§ndert';
      
      if (type === 'success') {
        alertClass = 'alert-success';
        icon = 'bi-check-circle';
        message = 'Timeframe erfolgreich aktualisiert';
      } else if (type === 'error') {
        alertClass = 'alert-danger';
        icon = 'bi-exclamation-triangle';
        message = 'Fehler beim Aktualisieren des Timeframes';
      }
      
      // Erstelle neue Benachrichtigung
      const notification = document.createElement('div');
      notification.className = `timeframe-notification alert ${alertClass} alert-dismissible fade show position-fixed`;
      notification.style.cssText = 'top: 20px; right: 20px; z-index: 1050; max-width: 300px;';
      
      const timeframeLabels = {
        '1m': '1 Minute',
        '5m': '5 Minuten', 
        '15m': '15 Minuten',
        '1h': '1 Stunde',
        '4h': '4 Stunden',
        '1d': '1 Tag'
      };
      
      notification.innerHTML = `
        <i class="bi ${icon}"></i>
        <strong>${message}:</strong> ${timeframeLabels[timeframe]}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      
      document.body.appendChild(notification);
      
      // Automatisch nach 3 Sekunden ausblenden
      setTimeout(() => {
        if (notification.parentNode) {
          notification.remove();
        }
      }, 3000);
    }
    
    // Funktion zum Anzeigen einer RSI-Perioden-Benachrichtigung
    function showRsiPeriodNotification(period, type = 'info') {
      // Entferne bestehende Benachrichtigung
      const existingNotification = document.querySelector('.rsi-period-notification');
      if (existingNotification) {
        existingNotification.remove();
      }
      
      // Bestimme CSS-Klasse basierend auf Typ
      let alertClass = 'alert-info';
      let icon = 'bi-graph-up';
      let message = 'RSI-Periode ge√§ndert';
      
      if (type === 'success') {
        alertClass = 'alert-success';
        icon = 'bi-check-circle';
        message = 'RSI-Periode erfolgreich aktualisiert';
      } else if (type === 'error') {
        alertClass = 'alert-danger';
        icon = 'bi-exclamation-triangle';
        message = 'Fehler beim Aktualisieren der RSI-Periode';
      }
      
      // Erstelle neue Benachrichtigung
      const notification = document.createElement('div');
      notification.className = `rsi-period-notification alert ${alertClass} alert-dismissible fade show position-fixed`;
      notification.style.cssText = 'top: 20px; right: 20px; z-index: 1050; max-width: 300px;';
      
      notification.innerHTML = `
        <i class="bi ${icon}"></i>
        <strong>${message}:</strong> ${period} Kerzen
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      
      document.body.appendChild(notification);
      
      // Automatisch nach 3 Sekunden ausblenden
      setTimeout(() => {
        if (notification.parentNode) {
          notification.remove();
        }
      }, 3000);
    }
    
    // Funktion zum Behandeln von Z√§hler-Updates
    function handleCounterUpdate(data) {
      console.log("üìä Verarbeite Z√§hler-Update:", data);
      
      const messageCounter = document.getElementById('message-counter');
      const klineCounter = document.getElementById('kline-counter');
      const priceUpdateCounter = document.getElementById('price-update-counter');
      const rsiCalculationCounter = document.getElementById('rsi-calculation-counter');
      const dataRateCounter = document.getElementById('data-rate-counter');
      
      console.log("üîç Gefundene Z√§hler-Elemente:", {
        messageCounter: messageCounter,
        klineCounter: klineCounter,
        priceUpdateCounter: priceUpdateCounter,
        dataRateCounter: dataRateCounter
      });
      
      if (messageCounter) {
        messageCounter.textContent = data.message_counter || 0;
        console.log("üí¨ Nachrichten-Z√§hler aktualisiert:", data.message_counter);
      } else {
        console.log("‚ö†Ô∏è message-counter Element nicht gefunden");
      }
      if (klineCounter) {
        klineCounter.textContent = data.kline_counter || 0;
        console.log("üìà Klines-Z√§hler aktualisiert:", data.kline_counter);
      } else {
        console.log("‚ö†Ô∏è kline-counter Element nicht gefunden");
      }
      if (priceUpdateCounter) {
        priceUpdateCounter.textContent = data.price_update_counter || 0;
        console.log("üí∞ Preis-Updates-Z√§hler aktualisiert:", data.price_update_counter);
      } else {
        console.log("‚ö†Ô∏è price-update-counter Element nicht gefunden");
      }
              if (dataRateCounter) {
          dataRateCounter.textContent = data.data_rate || 0;
          console.log("üíæ Datenrate aktualisiert:", data.data_rate);
        } else {
          console.log("‚ö†Ô∏è data-rate-counter Element nicht gefunden");
        }
    }
    
    // Starte automatische Z√§hler-Updates
    // ENTFERNT: Keine simulierten Z√§hler mehr - wir verwenden echte Daten vom WebSocket-Service...
    console.log("üéØ Warte auf echte Z√§hler-Updates vom WebSocket-Service...");
  }
});
</script>

<div class="container mt-4">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Kryptow√§hrungen Scanner</h1>
        <!-- Button Einstellungen entfernt -->
      </div>

      <!-- WebSocket Z√§hler -->
      <div class="mb-3">
        <div class="row">
          <div class="col-md-3">
            <div class="card border-primary">
              <div class="card-body text-center py-2">
                <h6 class="card-title text-primary mb-1">
                  <i class="bi bi-envelope"></i> Nachrichten
                </h6>
                <div class="h4 mb-0 text-primary" id="message-counter">0</div>
                <small class="text-muted">Empfangen</small>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card border-success">
              <div class="card-body text-center py-2">
                <h6 class="card-title text-success mb-1">
                  <i class="bi bi-graph-up"></i> Klines
                </h6>
                <div class="h4 mb-0 text-success" id="kline-counter">0</div>
                <small class="text-muted">Verarbeitet</small>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card border-warning">
              <div class="card-body text-center py-2">
                <h6 class="card-title text-warning mb-1">
                  <i class="bi bi-currency-dollar"></i> Preis-Updates
                </h6>
                <div class="h4 mb-0 text-warning" id="price-update-counter">0</div>
                <small class="text-muted">Gesendet</small>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card border-info">
              <div class="card-body text-center py-2">
                <h6 class="card-title text-info mb-1">
                  <i class="bi bi-speedometer"></i> Datenrate
                </h6>
                <div class="h4 mb-0 text-info" id="data-rate-counter">0</div>
                <small class="text-muted">Nachrichten/min</small>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Timeframe und RSI-Konfiguration -->
      <div class="mb-3">
        <div class="d-flex justify-content-between align-items-center">
          <div class="d-flex align-items-center gap-3">
            <div class="d-flex align-items-center">
              <label for="timeframe-selector" class="form-label me-2 mb-0">
                <i class="bi bi-clock"></i> Timeframe:
              </label>
              <select id="timeframe-selector" class="form-select form-select-sm" style="width: auto;">
                <option value="1m">1 Minute</option>
                <option value="5m">5 Minuten</option>
                <option value="15m">15 Minuten</option>
                <option value="1h">1 Stunde</option>
                <option value="4h">4 Stunden</option>
                <option value="1d">1 Tag</option>
              </select>
            </div>
            
            <div class="d-flex align-items-center">
              <label for="rsi-period-input" class="form-label me-2 mb-0">
                <i class="bi bi-graph-up"></i> RSI-Periode:
              </label>
              <input type="number" id="rsi-period-input" class="form-control form-control-sm" 
                     value="14" min="1" max="50" style="width: 80px;"
                     title="Anzahl der Kerzen f√ºr RSI-Berechnung (Standard: 14)">
            </div>
          </div>
          
          <!-- Live-Daten Status -->
          <div>
            <small class="text-success">
              <i class="bi bi-check-circle"></i> Live-Daten von Binance API (1m Updates)
            </small>
          </div>
        </div>
      </div>

      <!-- Durchschnittswerte -->
        <% if @average_rsi || @average_roc || @average_roc_derivative %>
          <div class="mb-2">
            <div class="d-flex gap-3 justify-content-end">
              <% if @average_rsi %>
                <% rsi_trend_icon = case @rsi_trend
                                     when 'up' then 'bi-arrow-up-right text-success'
                                     when 'down' then 'bi-arrow-down-right text-danger'
                                     else 'bi-arrow-right text-muted'
                                   end %>
                <small class="text-info averages-tooltip" 
                       data-bs-toggle="tooltip" 
                       data-bs-html="true"
                       data-bs-placement="bottom"
                       data-bs-custom-class="chart-tooltip"
                       data-chart-type="rsi"
                       title="<div class='text-center'>
                         <strong>RSI Durchschnitt</strong><br>
                         <span class='h5 text-info'><%= @average_rsi %></span><br>
                         <small class='text-muted'>Relative Strength Index</small><br>
                         <div class='mt-2'>
                           <i class='bi <%= rsi_trend_icon %>'></i>
                           <small class='text-muted ms-1'>Trend: <%= @rsi_trend == 'up' ? 'Anstieg' : (@rsi_trend == 'down' ? 'R√ºckgang' : 'Gleichbleibend') %></small>
                         </div>
                         <div class='mt-2'>
                           <canvas id='rsi-chart' width='200' height='60' style='max-width: 200px; max-height: 60px; border: 1px solid rgba(255,255,255,0.2);'></canvas>
                         </div>
                       </div>">
                  <%= link_to averages_chart_cryptocurrencies_path, target: '_blank', class: 'text-decoration-none text-info' do %>
                    <i class="bi bi-speedometer2"></i> RSI √ò: <strong><%= @average_rsi %></strong>
                    <i class="bi <%= rsi_trend_icon %> ms-1"></i>
                  <% end %>
                </small>
              <% end %>
            </div>
          </div>
        <% end %>
    </div>
  </div>
</div>

<% if @cryptocurrencies.any? %>
  <!-- Responsive Table View (alle Bildschirmgr√∂√üen) -->
  <div class="table-responsive">
    <table id="crypto-table" class="table table-hover">
      <thead class="table-dark">
        <tr>
          <th class="d-none d-md-table-cell">Rang</th>
          <th class="d-none d-lg-table-cell">Name</th>
          <th>Symbol</th>
          <th>Preis</th>
          <th class="d-none d-lg-table-cell">24h √Ñnderung</th>
          <th class="d-none d-xl-table-cell">Market Cap</th>
          <th class="d-none d-xl-table-cell">Volumen 24h (USD)</th>
          <th>
            RSI
            <% if @average_rsi %>
              <br><small class="text-info d-none d-md-inline">√ò <%= @average_rsi %></small>
            <% end %>
          </th>
          <th>
            ROC
            <br><small class="text-muted d-none d-md-inline">Rate of Change</small>
          </th>
          <th>
            ROC'
            <br><small class="text-muted d-none d-md-inline">ROC Derivative</small>
          </th>
        </tr>
      </thead>
      <tbody>
        <% @cryptocurrencies.each_with_index do |crypto, crypto_index| %>
          <tr data-crypto-id="<%= crypto.id %>">
            <td class="d-none d-md-table-cell">
              <span class="badge bg-secondary">#<%= crypto.market_cap_rank %></span>
            </td>
            <td class="d-none d-lg-table-cell">
              <strong><%= crypto.display_name %></strong>
            </td>
            <td>
              <%= link_to "https://www.binance.com/en/trade/#{crypto.base_symbol}_USDC?_from=markets&type=spot", 
                  target: '_blank',
                  class: 'text-decoration-none',
                  title: "#{crypto.display_name} auf Binance handeln" do %>
                <span class="badge bg-light text-dark"><%= crypto.base_symbol %></span>
              <% end %>
              <span class="d-md-none">
                <br><small class="text-muted">#<%= crypto.market_cap_rank %></small>
              </span>
            </td>
            <td data-sort="<%= @latest_prices[crypto.id] || 0 %>">
              <strong class="price-cell">
                <% price = @latest_prices[crypto.id] %>
                <% if price.present? %>
                  <%= link_to (price >= 1 ? "$#{price.round(2)}" : "$#{price.round(6)}"), chart_cryptocurrency_path(crypto), target: '_blank', class: 'text-decoration-none text-primary chart-link', title: 'Chart anzeigen' %>
                <% else %>
                  <span class="text-muted">N/A</span>
                <% end %>
              </strong>
            </td>
            <td class="d-none d-lg-table-cell">
              <% if crypto.price_change_percentage_24h %>
                <%# Bestimme die Farbe basierend auf Vollst√§ndigkeit der 24h-Daten %>
                <% color_class = if crypto.price_change_24h_complete?
                                   crypto.price_change_percentage_24h >= 0 ? 'text-success' : 'text-danger'
                                 else
                                   'text-danger' # Unvollst√§ndige Daten immer rot
                                 end %>
                <span class="<%= color_class %>">
                  <% if crypto.price_change_percentage_24h >= 0 %>
                    <i class="bi bi-arrow-up"></i>
                  <% else %>
                    <i class="bi bi-arrow-down"></i>
                  <% end %>
                  <%= crypto.price_change_percentage_24h_formatted %>
                </span>
              <% else %>
                <span class="text-muted">0.00%</span>
              <% end %>
            </td>
            <td class="d-none d-xl-table-cell"><%= crypto.formatted_market_cap %></td>
            <td class="d-none d-xl-table-cell">
              <%= crypto.formatted_volume_24h %>
            </td>
            <td data-sort="<%= crypto.current_rsi(@current_timeframe) || -1 %>">
              <% if crypto.current_rsi(@current_timeframe) %>
                <% rsi_class = if crypto.current_rsi(@current_timeframe) <= 30
                                 "rsi-oversold"
                               elsif crypto.current_rsi(@current_timeframe) >= 70
                                 "rsi-overbought"
                               else
                                 "rsi-neutral"
                               end %>
                <%= link_to chart_cryptocurrency_path(crypto), 
                    target: '_blank',
                    class: 'text-decoration-none',
                    title: "RSI Chart anzeigen" do %>
                  <span class="badge <%= rsi_class %> chart-link rsi-cell">
                    <%= crypto.current_rsi(@current_timeframe) %>
                  </span>
                <% end %>
              <% else %>
                <span class="badge bg-secondary rsi-cell">N/A</span>
              <% end %>
            </td>
            
            <td data-sort="<%= crypto.current_roc(@current_timeframe) || -999 %>">
              <% if crypto.current_roc(@current_timeframe) %>
                <% roc_class = if crypto.current_roc(@current_timeframe) >= 5
                                 "bg-success"
                               elsif crypto.current_roc(@current_timeframe) <= -5
                                 "bg-danger"
                               else
                                 "bg-secondary"
                               end %>
                <span class="badge <%= roc_class %> roc-cell">
                  <%= crypto.current_roc(@current_timeframe).round(2) %>%
                </span>
              <% else %>
                <span class="badge bg-secondary roc-cell">N/A</span>
              <% end %>
            </td>
            
            <td data-sort="<%= crypto.current_roc_derivative(@current_timeframe) || -999 %>">
              <% if crypto.current_roc_derivative(@current_timeframe) %>
                <% roc_derivative_class = if crypto.current_roc_derivative(@current_timeframe) >= 2
                                            "bg-success"
                                          elsif crypto.current_roc_derivative(@current_timeframe) <= -2
                                            "bg-danger"
                                          else
                                            "bg-secondary"
                                          end %>
                <span class="badge <%= roc_derivative_class %> roc-derivative-cell">
                  <%= crypto.current_roc_derivative(@current_timeframe).round(2) %>%
                </span>
              <% else %>
                <span class="badge bg-secondary roc-derivative-cell">N/A</span>
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
<% else %>
  <!-- Empty State -->
  <div class="text-center py-5">
    <i class="bi bi-exclamation-triangle display-1 text-warning"></i>
    <h3 class="mt-3">Keine Daten verf√ºgbar</h3>
    <p class="text-muted">
      Es konnten keine Kryptow√§hrungsdaten geladen werden. 
      Bitte √ºberpr√ºfen Sie Ihre Internetverbindung und versuchen Sie es erneut.
    </p>
  </div>
<% end %> 